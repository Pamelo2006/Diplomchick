{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã BPMN-—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />

    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #top-panel { background: #f1f1f1; padding: 10px; display: flex; }
        .btn { padding: 10px; margin-right: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        #bpmn-editor { width: 100%; height: 600px; border: 1px solid #ccc; background: #f9f9f9; margin-top: 10px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
    </style>

    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>

    <script>
  document.addEventListener('DOMContentLoaded', function () {
    const bpmnContainer = document.getElementById('bpmn-editor');
    const xmlDataField = document.getElementById('id_xml_data'); // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è XML
    const form = document.querySelector('form');
    let bpmnModeler;

    if (!bpmnContainer) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #bpmn-editor –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    bpmnModeler = new BpmnJS({
        container: bpmnContainer
    });

    // –ü–æ–ª—É—á–∞–µ–º XML –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
    let initialXML = xmlDataField?.value?.trim();

    if (!initialXML) {
        initialXML = `<?xml version="1.0" encoding="UTF-8"?>
        <bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                          xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                          xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                          id="Definitions_1"
                          targetNamespace="http://bpmn.io/schema/bpmn">
          <bpmn:process id="Process_1" isExecutable="false">
            <bpmn:startEvent id="StartEvent_1"/>
          </bpmn:process>
          <bpmndi:BPMNDiagram id="BPMNDiagram_1">
            <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
              <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="100" y="100" width="36" height="36"/>
              </bpmndi:BPMNShape>
            </bpmndi:BPMNPlane>
          </bpmndi:BPMNDiagram>
        </bpmn:definitions>`;
    }

    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
    bpmnModeler.importXML(initialXML).then(() => {
        console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
    }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ BPMN XML:", err);
    });

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function saveDiagram(name) {
        try {
            const { xml } = await bpmnModeler.saveXML({ format: true });

            const response = await fetch('/builder/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    bpmn: xml
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', result);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã.');
            }

        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è BPMN XML:", err);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    document.getElementById('save-button').addEventListener('click', function (event) {
        event.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
        const modal = document.getElementById('nameModal');
        modal.style.display = "block";
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('modal-save-button').addEventListener('click', function (event) {
        const nameInput = document.getElementById('diagram-name');
        const name = nameInput.value.trim();
        if (name) {
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('nameModal');
            modal.style.display = "none";

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É —Å –≤–≤–µ–¥–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
            saveDiagram(name);
        } else {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–∏–∞–≥—Ä–∞–º–º—ã');
        }
    });

    // –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º XML –¥–∏–∞–≥—Ä–∞–º–º—ã –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
    form.addEventListener('submit', async function () {
        try {
            const { xml } = await bpmnModeler.saveXML({ format: true });
            xmlDataField.value = xml; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º XML –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è BPMN XML –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã:", err);
        }

    });
});
    </script>
{% endblock %}

{% block content %}
    <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –¥–∏–∞–≥—Ä–∞–º–º BPMN</h1>
    <div id="top-panel">
        <button id="save-button" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="bpmn-editor"></div>
    {{ block.super }}
    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è XML -->
    <input type="hidden" id="id_xml_data" name="xml_data" value="{{ form.initial.xml_data }}">

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–∏–∞–≥—Ä–∞–º–º—ã:</p>
            <input type="text" id="diagram-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã">
            <button id="modal-save-button" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
{% endblock %}
