<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #top-panel { background: #f1f1f1; padding: 10px; display: flex; }
        .btn { padding: 10px; margin-right: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        #bpmn-container { width: 100%; height: 600px; border: 1px solid #ccc; background: #f9f9f9; margin-top: 10px; }
    </style>
</head>
<body>

<h1>BPMN –†–µ–¥–∞–∫—Ç–æ—Ä</h1>
<div id="top-panel">
    <button class="btn" onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" onclick="loadDiagram()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div id="bpmn-container"></div>

<script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
<script>
    const container = document.getElementById('bpmn-container');
    const modeler = new BpmnJS({ container });

    const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
    <bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                      xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                      xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      id="Definitions_1"
                      targetNamespace="http://bpmn.io/schema/bpmn">
      <bpmn:process id="Process_1" isExecutable="false">
        <bpmn:startEvent id="StartEvent_1"/>
      </bpmn:process>
      <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
          <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
            <dc:Bounds x="100" y="100" width="36" height="36"/>
          </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
      </bpmndi:BPMNDiagram>
    </bpmn:definitions>`;

    async function createDiagram() {
        try {
            await modeler.importXML(emptyDiagram);
            console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
        }
    }

    createDiagram();

    async function saveDiagram() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

        try {
            const { xml } = await modeler.saveXML({ format: true });

            const response = await fetch('/builder/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    bpmn: xml
                })
            });

            if(response.ok) {
                alert('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            }
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    async function loadDiagram() {
        const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

        if (!diagramId) return;

        try {
            const response = await fetch(`/builder/load/${diagramId}/`);
            const { xml } = await response.json();

            await modeler.importXML(xml);
            modeler.get('canvas').zoom('fit-viewport');
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
    }
</script>

</body>
</html>