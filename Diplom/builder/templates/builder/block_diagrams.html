<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #top-panel { background: #f1f1f1; padding: 10px; display: flex; }
        .btn { padding: 10px; margin-right: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        #bpmn-container { width: 100%; height: 600px; border: 1px solid #ccc; background: #f9f9f9; margin-top: 10px; }
    </style>
</head>
<body>

<h1>BPMN –†–µ–¥–∞–∫—Ç–æ—Ä</h1>
<h2>{{ username }}</h2>
<div id="top-panel">
    <button class="btn" onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" onclick="loadDiagram()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div style="display: inline-block; margin-left: 10px;">
        <select id="export-format" class="btn" style="padding: 10px; height: 40px;">
            <option value="" selected disabled>–≠–∫—Å–ø–æ—Ä—Ç –≤...</option>
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
            <option value="pdf">PDF</option>
        </select>
        <button class="btn" onclick="exportDiagram()" style="margin-left: 5px;">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
</div>


<div id="bpmn-container"></div>

<script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
<script>
    const container = document.getElementById('bpmn-container');
    const modeler = new BpmnJS({ container });

    const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_1njeaep</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:task id="Activity_1f34r67">
      <bpmn:incoming>Flow_1njeaep</bpmn:incoming>
      <bpmn:outgoing>Flow_0dav32j</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1njeaep" sourceRef="StartEvent_1" targetRef="Activity_1f34r67" />
    <bpmn:exclusiveGateway id="Gateway_12lufs0">
      <bpmn:incoming>Flow_0dav32j</bpmn:incoming>
      <bpmn:incoming>Flow_1uwkt9p</bpmn:incoming>
      <bpmn:outgoing>Flow_1rderyx</bpmn:outgoing>
      <bpmn:outgoing>Flow_1khs6ti</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_0dav32j" sourceRef="Activity_1f34r67" targetRef="Gateway_12lufs0" />
    <bpmn:task id="Activity_1a81vl9">
      <bpmn:incoming>Flow_1rderyx</bpmn:incoming>
      <bpmn:outgoing>Flow_0a8wsv1</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1rderyx" sourceRef="Gateway_12lufs0" targetRef="Activity_1a81vl9" />
    <bpmn:endEvent id="Event_1hglcpn">
      <bpmn:incoming>Flow_0a8wsv1</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0a8wsv1" sourceRef="Activity_1a81vl9" targetRef="Event_1hglcpn" />
    <bpmn:task id="Activity_02i1ibo">
      <bpmn:incoming>Flow_1khs6ti</bpmn:incoming>
      <bpmn:outgoing>Flow_1uwkt9p</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1khs6ti" sourceRef="Gateway_12lufs0" targetRef="Activity_02i1ibo" />
    <bpmn:sequenceFlow id="Flow_1uwkt9p" sourceRef="Activity_02i1ibo" targetRef="Gateway_12lufs0" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="332" y="192" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_12lufs0_di" bpmnElement="Gateway_12lufs0" isMarkerVisible="true">
        <dc:Bounds x="575" y="295" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1a81vl9_di" bpmnElement="Activity_1a81vl9">
        <dc:Bounds x="680" y="280" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1hglcpn_di" bpmnElement="Event_1hglcpn">
        <dc:Bounds x="842" y="302" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1f34r67_di" bpmnElement="Activity_1f34r67">
        <dc:Bounds x="430" y="170" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_02i1ibo_di" bpmnElement="Activity_02i1ibo">
        <dc:Bounds x="720" y="390" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1njeaep_di" bpmnElement="Flow_1njeaep">
        <di:waypoint x="368" y="210" />
        <di:waypoint x="430" y="210" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0dav32j_di" bpmnElement="Flow_0dav32j">
        <di:waypoint x="530" y="210" />
        <di:waypoint x="600" y="210" />
        <di:waypoint x="600" y="295" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1rderyx_di" bpmnElement="Flow_1rderyx">
        <di:waypoint x="625" y="320" />
        <di:waypoint x="680" y="320" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0a8wsv1_di" bpmnElement="Flow_0a8wsv1">
        <di:waypoint x="780" y="320" />
        <di:waypoint x="842" y="320" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1khs6ti_di" bpmnElement="Flow_1khs6ti">
        <di:waypoint x="600" y="345" />
        <di:waypoint x="600" y="430" />
        <di:waypoint x="720" y="430" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1uwkt9p_di" bpmnElement="Flow_1uwkt9p">
        <di:waypoint x="820" y="430" />
        <di:waypoint x="860" y="430" />
        <di:waypoint x="860" y="510" />
        <di:waypoint x="600" y="510" />
        <di:waypoint x="600" y="345" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    async function createDiagram() {
        try {
            await modeler.importXML(emptyDiagram);
            console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
        }
    }

    createDiagram();

    async function saveDiagram() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

        try {
            const { xml } = await modeler.saveXML({ format: true });

            const response = await fetch('/builder/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    bpmn: xml,
                    username: '{{ username }}'  // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                })
            });

            if(response.ok) {
                alert('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            }
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    async function loadDiagram() {
        const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

        if (!diagramId) return;

        try {
            const response = await fetch(`/builder/load/${diagramId}/`);
            const { xml } = await response.json();

            await modeler.importXML(xml);
            modeler.get('canvas').zoom('fit-viewport');
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
    }

    async function exportDiagram() {
    const formatSelect = document.getElementById('export-format');
    const format = formatSelect.value;

    if (!format) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    try {
        if (format === 'svg') {
            const { svg } = await modeler.saveSVG();
            downloadFile(svg, 'diagram.svg', 'image/svg+xml');
            return;
        }

        // –î–ª—è PDF –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
        if (format === 'pdf') {
            const { svg } = await modeler.saveSVG();
            const response = await fetch('/builder/export/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    svg: svg,
                    format: 'pdf',
                    filename: 'diagram'
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                downloadFile(blob, 'diagram.pdf', 'application/pdf');
            } else {
                throw new Error(await response.text());
            }
            return;
        }

        // –î–ª—è PNG/JPG –∏—Å–ø–æ–ª—å–∑—É–µ–º canvas
        const { svg } = await modeler.saveSVG();
        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;

            // –ó–∞–ª–∏–≤–∞–µ–º –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º –¥–ª—è JPG
            if (format === 'jpg') {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.drawImage(img, 0, 0);

            let mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
            canvas.toBlob(blob => {
                downloadFile(blob, `diagram.${format}`, mimeType);
            }, mimeType, 1.0);
        };

        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    } catch(error) {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
    }
}

function downloadFile(content, filename, mimeType) {
    const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


</script>

</body>
</html>