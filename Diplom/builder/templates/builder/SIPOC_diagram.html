<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN Builder - SIPOC</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #66a5ad;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --light-gray: #f5f7fa;
            --dark-gray: #333;
            --white: #fff;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --suppliers-color: #FFD54F;
            --input-color: #81C784;
            --process-color: #64B5F6;
            --output-color: #BA68C8;
            --customers-color: #FF8A65;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background-color: var(--light-gray);
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin: 0;
            color: var(--white);
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--white);
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        #top-panel {
            background: var(--white);
            padding: 15px;
            display: flex;
            gap: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        #bpmn-container {
            width: 100%;
            height: 700px;
            margin: 0 auto;
            border: 1px solid #ddd;
            background: var(--white);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: var(--white);
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .export-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #top-panel {
                flex-direction: column;
            }
            
            .btn, select {
                width: 100%;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #bpmn-container {
            animation: fadeIn 0.5s ease-in;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–π–±–ª–æ–≤ –¥–æ—Ä–æ–∂–µ–∫ */
        .djs-label {
            font-weight: bold !important;
            font-size: 14px !important;
        }
        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    body.dark-theme {
        --light-gray: #121212;
        --dark-gray: #e0e0e0;
        --white: #1e1e1e;
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }

    body.dark-theme header {
        background-color: #1a1a1a;
        
    }

    body.dark-h1{
        color: #e0e0e0;;
    }

    body.dark-theme #top-panel {
        background: #2d2d2d;
        color: var(--dark-gray);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    body.dark-theme select {
        background-color: #3d3d3d;
        color: var(--dark-gray);
        border-color: #444;
    }

    body.dark-theme .btn {
        background-color: #2d2d2d;
        color: var(--dark-gray);
    }

    body.dark-theme .btn:hover {
        background-color: #3d3d3d;
    }

    body.dark-theme #bpmn-container {
        background: #2d2d2d;
        border-color: #444;
    }

    body.dark-theme .export-wrapper label {
        color: var(--dark-gray);
    }
    </style>
</head>
<body>
  <header>
    <div class="container header-content">
        <div>
            <h1 id="diagramTitle">SIPOC-–¥–∏–∞–≥—Ä–∞–º–º–∞</h1>
            <h2>{{ username }}</h2>
        </div>
    </div>
</header>

<div class="container">
    <div id="top-panel">
        <button class="btn" id="saveButton" onclick="saveDiagram()">
            <i>üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button class="btn" id="loadButton" onclick="loadDiagram()">
            <i>üìÇ</i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
        <form action="{% url 'back_to_diagrams' %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn" id="exitButton">
                <i>üö™</i> –í—ã–π—Ç–∏
            </button>
        </form>
        
        <div class="export-wrapper">
            <select id="export-format" class="btn" onchange="exportDiagram()">
                <option value="" selected disabled id="exportOption">–≠–∫—Å–ø–æ—Ä—Ç...</option>
                <option value="png">PNG</option>
                <option value="jpg">JPG</option>
                <option value="pdf">PDF</option>
            </select>
        </div>

        <div class="dropdown-section">
            <span id="languageLabel">–Ø–∑—ã–∫: </span>
            <select class="language-select" id="languageSelect">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="dropdown-section_1">
          <span id="temLabel">–¢–µ–º–∞: </span>
          <select class="language-select" id="themeSelect">
              <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
              <option value="dark">–¢–µ–º–Ω–∞—è</option>
          </select>
      </div>
    </div>
    <div id="bpmn-container"></div>
</div>

    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <script>
        const container = document.getElementById('bpmn-container');
        const modeler = new BpmnJS({ container });

        const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:collaboration id="Collaboration_1t5qubl">
    <bpmn:participant id="Participant_0nm4jpf" processRef="Process_1" />
  </bpmn:collaboration>
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:laneSet id="LaneSet_0h152rq">
      <bpmn:lane id="Lane_0ifx770" name="suppliers">
        <bpmn:flowNodeRef>Activity_0bbqvti</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_1g18xvk</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_1s7r6kg" name="input">
        <bpmn:flowNodeRef>Event_10yalja</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_1i692nr</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_0plcbdb</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_1w63i8r</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_0a5ctwl" name="process">
        <bpmn:flowNodeRef>Event_1ebb5m6</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0f4h93u</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_091nulq</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_02cohb0</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_01z5qoa</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_12gxorv" name="output">
        <bpmn:flowNodeRef>Event_1dv11ty</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_0e7w3wd</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_1v0c4qd</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_1do2ccq</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_0qqbz6y" name="customers">
        <bpmn:flowNodeRef>Activity_1gx1tpb</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0jabxp7</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:task id="Activity_0bbqvti">
      <bpmn:outgoing>Flow_1j9tw5z</bpmn:outgoing>
      <bpmn:outgoing>Flow_0ldpsbu</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0pc5ea0" sourceRef="Activity_1g18xvk" targetRef="Event_1w63i8r" />
    <bpmn:sequenceFlow id="Flow_0nsigmy" sourceRef="Activity_1g18xvk" targetRef="Event_0plcbdb" />
    <bpmn:sequenceFlow id="Flow_1j9tw5z" sourceRef="Activity_0bbqvti" targetRef="Event_10yalja" />
    <bpmn:sequenceFlow id="Flow_0ldpsbu" sourceRef="Activity_0bbqvti" targetRef="Event_1i692nr" />
    <bpmn:intermediateThrowEvent id="Event_10yalja">
      <bpmn:incoming>Flow_1j9tw5z</bpmn:incoming>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Event_1i692nr">
      <bpmn:incoming>Flow_0ldpsbu</bpmn:incoming>
    </bpmn:intermediateThrowEvent>
    <bpmn:startEvent id="Event_1ebb5m6">
      <bpmn:outgoing>Flow_138hav9</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:task id="Activity_0f4h93u">
      <bpmn:incoming>Flow_138hav9</bpmn:incoming>
      <bpmn:outgoing>Flow_0mochxj</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_138hav9" sourceRef="Event_1ebb5m6" targetRef="Activity_0f4h93u" />
    <bpmn:task id="Activity_091nulq">
      <bpmn:incoming>Flow_0mochxj</bpmn:incoming>
      <bpmn:outgoing>Flow_0zs0apt</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0mochxj" sourceRef="Activity_0f4h93u" targetRef="Activity_091nulq" />
    <bpmn:task id="Activity_02cohb0">
      <bpmn:incoming>Flow_0zs0apt</bpmn:incoming>
      <bpmn:outgoing>Flow_0lvx0ap</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0zs0apt" sourceRef="Activity_091nulq" targetRef="Activity_02cohb0" />
    <bpmn:endEvent id="Event_01z5qoa">
      <bpmn:incoming>Flow_0lvx0ap</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0lvx0ap" sourceRef="Activity_02cohb0" targetRef="Event_01z5qoa" />
    <bpmn:intermediateThrowEvent id="Event_1dv11ty">
      <bpmn:outgoing>Flow_153522h</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Event_0e7w3wd">
      <bpmn:outgoing>Flow_1ktbnb6</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Event_1v0c4qd">
      <bpmn:outgoing>Flow_0w6jhpm</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Event_1do2ccq">
      <bpmn:outgoing>Flow_0r2n0gn</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:task id="Activity_1gx1tpb">
      <bpmn:incoming>Flow_153522h</bpmn:incoming>
      <bpmn:incoming>Flow_1ktbnb6</bpmn:incoming>
    </bpmn:task>
    <bpmn:task id="Activity_0jabxp7">
      <bpmn:incoming>Flow_0w6jhpm</bpmn:incoming>
      <bpmn:incoming>Flow_0r2n0gn</bpmn:incoming>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_153522h" sourceRef="Event_1dv11ty" targetRef="Activity_1gx1tpb" />
    <bpmn:sequenceFlow id="Flow_1ktbnb6" sourceRef="Event_0e7w3wd" targetRef="Activity_1gx1tpb" />
    <bpmn:sequenceFlow id="Flow_0w6jhpm" sourceRef="Event_1v0c4qd" targetRef="Activity_0jabxp7" />
    <bpmn:sequenceFlow id="Flow_0r2n0gn" sourceRef="Event_1do2ccq" targetRef="Activity_0jabxp7" />
    <bpmn:intermediateThrowEvent id="Event_0plcbdb">
      <bpmn:incoming>Flow_0nsigmy</bpmn:incoming>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Event_1w63i8r">
      <bpmn:incoming>Flow_0pc5ea0</bpmn:incoming>
    </bpmn:intermediateThrowEvent>
    <bpmn:task id="Activity_1g18xvk">
      <bpmn:outgoing>Flow_0pc5ea0</bpmn:outgoing>
      <bpmn:outgoing>Flow_0nsigmy</bpmn:outgoing>
    </bpmn:task>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_1t5qubl">
      <bpmndi:BPMNShape id="Participant_0nm4jpf_di" bpmnElement="Participant_0nm4jpf" isHorizontal="true">
        <dc:Bounds x="290" y="90" width="708" height="610" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0ifx770_di" bpmnElement="Lane_0ifx770" isHorizontal="true">
        <dc:Bounds x="320" y="90" width="678" height="125" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1s7r6kg_di" bpmnElement="Lane_1s7r6kg" isHorizontal="true">
        <dc:Bounds x="320" y="215" width="678" height="125" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0a5ctwl_di" bpmnElement="Lane_0a5ctwl" isHorizontal="true">
        <dc:Bounds x="320" y="340" width="678" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_12gxorv_di" bpmnElement="Lane_12gxorv" isHorizontal="true">
        <dc:Bounds x="320" y="460" width="678" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0qqbz6y_di" bpmnElement="Lane_0qqbz6y" isHorizontal="true">
        <dc:Bounds x="320" y="580" width="678" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0bbqvti_di" bpmnElement="Activity_0bbqvti">
        <dc:Bounds x="710" y="110" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_10yalja_di" bpmnElement="Event_10yalja">
        <dc:Bounds x="702" y="252" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1i692nr_di" bpmnElement="Event_1i692nr">
        <dc:Bounds x="792" y="252" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1ebb5m6_di" bpmnElement="Event_1ebb5m6">
        <dc:Bounds x="362" y="372" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0f4h93u_di" bpmnElement="Activity_0f4h93u">
        <dc:Bounds x="450" y="350" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_091nulq_di" bpmnElement="Activity_091nulq">
        <dc:Bounds x="610" y="350" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_02cohb0_di" bpmnElement="Activity_02cohb0">
        <dc:Bounds x="770" y="350" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_01z5qoa_di" bpmnElement="Event_01z5qoa">
        <dc:Bounds x="932" y="372" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1dv11ty_di" bpmnElement="Event_1dv11ty">
        <dc:Bounds x="362" y="502" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0e7w3wd_di" bpmnElement="Event_0e7w3wd">
        <dc:Bounds x="442" y="502" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1v0c4qd_di" bpmnElement="Event_1v0c4qd">
        <dc:Bounds x="702" y="502" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1do2ccq_di" bpmnElement="Event_1do2ccq">
        <dc:Bounds x="812" y="502" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1gx1tpb_di" bpmnElement="Activity_1gx1tpb">
        <dc:Bounds x="370" y="600" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0jabxp7_di" bpmnElement="Activity_0jabxp7">
        <dc:Bounds x="730" y="600" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0plcbdb_di" bpmnElement="Event_0plcbdb">
        <dc:Bounds x="362" y="252" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1w63i8r_di" bpmnElement="Event_1w63i8r">
        <dc:Bounds x="472" y="252" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1g18xvk_di" bpmnElement="Activity_1g18xvk">
        <dc:Bounds x="380" y="110" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0pc5ea0_di" bpmnElement="Flow_0pc5ea0">
        <di:waypoint x="430" y="190" />
        <di:waypoint x="430" y="270" />
        <di:waypoint x="472" y="270" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0nsigmy_di" bpmnElement="Flow_0nsigmy">
        <di:waypoint x="430" y="190" />
        <di:waypoint x="430" y="270" />
        <di:waypoint x="398" y="270" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1j9tw5z_di" bpmnElement="Flow_1j9tw5z">
        <di:waypoint x="760" y="190" />
        <di:waypoint x="760" y="221" />
        <di:waypoint x="720" y="221" />
        <di:waypoint x="720" y="252" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ldpsbu_di" bpmnElement="Flow_0ldpsbu">
        <di:waypoint x="760" y="190" />
        <di:waypoint x="760" y="221" />
        <di:waypoint x="810" y="221" />
        <di:waypoint x="810" y="252" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_138hav9_di" bpmnElement="Flow_138hav9">
        <di:waypoint x="398" y="390" />
        <di:waypoint x="450" y="390" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0mochxj_di" bpmnElement="Flow_0mochxj">
        <di:waypoint x="550" y="390" />
        <di:waypoint x="610" y="390" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0zs0apt_di" bpmnElement="Flow_0zs0apt">
        <di:waypoint x="710" y="390" />
        <di:waypoint x="770" y="390" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0lvx0ap_di" bpmnElement="Flow_0lvx0ap">
        <di:waypoint x="870" y="390" />
        <di:waypoint x="932" y="390" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_153522h_di" bpmnElement="Flow_153522h">
        <di:waypoint x="380" y="538" />
        <di:waypoint x="380" y="569" />
        <di:waypoint x="420" y="569" />
        <di:waypoint x="420" y="600" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1ktbnb6_di" bpmnElement="Flow_1ktbnb6">
        <di:waypoint x="460" y="538" />
        <di:waypoint x="460" y="569" />
        <di:waypoint x="420" y="569" />
        <di:waypoint x="420" y="600" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0w6jhpm_di" bpmnElement="Flow_0w6jhpm">
        <di:waypoint x="720" y="538" />
        <di:waypoint x="720" y="569" />
        <di:waypoint x="780" y="569" />
        <di:waypoint x="780" y="600" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0r2n0gn_di" bpmnElement="Flow_0r2n0gn">
        <di:waypoint x="830" y="538" />
        <di:waypoint x="830" y="569" />
        <di:waypoint x="780" y="569" />
        <di:waypoint x="780" y="600" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        async function createDiagram() {
            try {
                await modeler.importXML(emptyDiagram);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ –¥–æ—Ä–æ–∂–µ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    const modeling = modeler.get('modeling');
                    const elementRegistry = modeler.get('elementRegistry');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –¥–æ—Ä–æ–∂–µ–∫
                    const setLaneColor = (id, color) => {
                        const element = elementRegistry.get(id);
                        if (element) {
                            modeling.setColor(element, {
                                fill: color + '40', // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                                stroke: color
                            });
                        }
                    };
                    
                    setLaneColor('Lane_0ifx770', 'var(--suppliers-color)');
                    setLaneColor('Lane_1s7r6kg', 'var(--input-color)');
                    setLaneColor('Lane_0a5ctwl', 'var(--process-color)');
                    setLaneColor('Lane_12gxorv', 'var(--output-color)');
                    setLaneColor('Lane_0qqbz6y', 'var(--customers-color)');
                    
                }, 500);
                
                //showNotification('–®–∞–±–ª–æ–Ω SIPOC –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞ SIPOC', 'error');
            }
        }

        createDiagram();

        async function saveDiagram() {
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "SIPOC –¥–∏–∞–≥—Ä–∞–º–º–∞");

            if (!name) return;

            try {
                const { xml } = await modeler.saveXML({ format: true });

                const response = await fetch('/builder/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        name: name,
                        bpmn: xml,
                        username: '{{ username }}'
                    })
                });

                if(response.ok) {
                    showNotification('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                } else {
                    throw new Error(await response.text());
                }
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        async function loadDiagram() {
            const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

            if (!diagramId) return;

            try {
                const response = await fetch(`/builder/load/${diagramId}/`);
                const { xml } = await response.json();

                await modeler.importXML(xml);
                modeler.get('canvas').zoom('fit-viewport');
                showNotification('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã', 'error');
            }
        }

        async function exportDiagram() {
            const formatSelect = document.getElementById('export-format');
            const format = formatSelect.value;

            if (!format) return;

            try {
                if (format === 'svg') {
                    const { svg } = await modeler.saveSVG();
                    downloadFile(svg, 'diagram.svg', 'image/svg+xml');
                    showNotification('SVG —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                    return;
                }

                if (format === 'pdf') {
                    const { svg } = await modeler.saveSVG();
                    const response = await fetch('/builder/export/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            svg: svg,
                            format: 'pdf',
                            filename: 'diagram'
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        downloadFile(blob, 'diagram.pdf', 'application/pdf');
                        showNotification('PDF —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                    } else {
                        throw new Error(await response.text());
                    }
                    return;
                }

                const { svg } = await modeler.saveSVG();
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    if (format === 'jpg') {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }

                    ctx.drawImage(img, 0, 0);

                    let mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                    canvas.toBlob(blob => {
                        downloadFile(blob, `diagram.${format}`, mimeType);
                        showNotification(`–§–∞–π–ª ${format.toUpperCase()} —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω`, 'success');
                    }, mimeType, 1.0);
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                formatSelect.value = '';
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message, 'error');
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        // –û–±—ä–µ–∫—Ç —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const translations = {
        'ru': {
            'diagramTitle': 'SIPOC-–¥–∏–∞–≥—Ä–∞–º–º–∞',
            'saveButton': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
            'loadButton': '–ó–∞–≥—Ä—É–∑–∏—Ç—å',
            'exitButton': '–í—ã–π—Ç–∏',
            'exportOption': '–≠–∫—Å–ø–æ—Ä—Ç...',
            'languageLabel': '–Ø–∑—ã–∫:'
        },
        'en': {
            'diagramTitle': 'SIPOC-diagram',
            'saveButton': 'Save',
            'loadButton': 'Load',
            'exitButton': 'Exit',
            'exportOption': 'Export...',
            'languageLabel': 'Language:'
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function translatePage(lang) {
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
        const t = translations[lang];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.querySelector('h1').textContent = t.diagramTitle;
        document.getElementById('saveButton').innerHTML = `<i>üíæ</i> ${t.saveButton}`;
        document.getElementById('loadButton').innerHTML = `<i>üìÇ</i> ${t.loadButton}`;
        document.getElementById('exitButton').innerHTML = `<i>üö™</i> ${t.exitButton}`;
        document.getElementById('exportOption').textContent = t.exportOption;
        document.getElementById('languageLabel').textContent = t.languageLabel;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ localStorage
        localStorage.setItem('userLanguage', lang);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        updateLanguageOnServer(lang);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    function updateLanguageOnServer(lang) {
        fetch('/update_language/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                language: lang,
                username: '{{ username }}'
            })
        }).catch(err => console.error('Language update error:', err));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
        const languageSelect = document.getElementById('languageSelect');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä—É—Å—Å–∫–∏–π)
        const defaultLanguage = 'ru';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏–∑ localStorage
        const savedLanguage = localStorage.getItem('userLanguage');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ localStorage, –ø–æ—Ç–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const currentLanguage = savedLanguage || defaultLanguage;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        languageSelect.value = currentLanguage;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
        translatePage(currentLanguage);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
        languageSelect.addEventListener('change', function() {
            const selectedLanguage = this.value;
            translatePage(selectedLanguage);
        });
    });

    //—Ç–µ–º–∞
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.remove('dark-theme');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    async function updateTheme(theme) {
        try {
            const response = await fetch('/update_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    theme: theme,
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Failed to update theme');
            }
        } catch (error) {
            console.error('Error updating theme:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function getUserTheme() {
        try {
            const response = await fetch('/get_user_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            return data.theme || 'light';
        } catch (error) {
            console.error('Error getting user theme:', error);
            return 'light';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async function() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        const currentTheme = await getUserTheme();
        applyTheme(currentTheme);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        const themeSelect = document.getElementById('themeSelect');
        if (themeSelect) {
            themeSelect.value = currentTheme;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        themeSelect.addEventListener('change', function() {
            const selectedTheme = this.value;
            applyTheme(selectedTheme);
            updateTheme(selectedTheme);
        });
    });
    </script>
</body>
</html>