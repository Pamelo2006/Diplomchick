<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN Builder</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º BPMN.js -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <style>
        :root {
            --primary-color: #66a5ad;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --light-gray: #f5f7fa;
            --dark-gray: #333;
            --white: #fff;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background-color: var(--light-gray);
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin: 0;
            color: var(--white);
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--white);
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        #top-panel {
            background: var(--white);
            padding: 15px;
            display: flex;
            gap: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 1rem;
        }

        #bpmn-container {
            width: 100%;
            height: 600px;
            margin: 0 auto;
            border: 1px solid #ddd;
            background: var(--white);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: var(--white);
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .export-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-wrapper label {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #top-panel {
                flex-direction: column;
            }
            
            .btn, select {
                width: 100%;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #bpmn-container {
            animation: fadeIn 0.5s ease-in;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

         /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    body.dark-theme {
        --light-gray: #121212;
        --dark-gray: #e0e0e0;
        --white: #1e1e1e;
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }

    body.dark-theme header {
        background-color: #1a1a1a;
        
    }
    
    body.dark-theme #top-panel {
        background: #2d2d2d;
        color: var(--dark-gray);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    body.dark-theme select {
        background-color: #3d3d3d;
        color: var(--dark-gray);
        border-color: #444;
    }

    body.dark-theme .btn {
        background-color: #2d2d2d;
        color: var(--dark-gray);
    }

    body.dark-theme .btn:hover {
        background-color: #3d3d3d;
    }

    body.dark-theme #bpmn-container {
        background: #2d2d2d;
        border-color: #444;
    }

    body.dark-theme .export-wrapper label {
        color: var(--dark-gray);
    }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div>
                <h1>–î–∏–∞–≥—Ä–∞–º–º–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h1>
                <h2>{{ username }}</h2>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Diagram container -->
        <div id="top-panel">
            <button class="btn" id="saveButton" onclick="saveDiagram()">
                <i>üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn" id="loadButton" onclick="loadDiagram()">
                <i>üìÇ</i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
            <form action="{% url 'back_to_diagrams' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn" id="exitButton">
                    <i>üö™</i> –í—ã–π—Ç–∏
                </button>
            </form>
            
            <!-- Export selector -->
            <div class="export-wrapper">
                <select id="export-format" class="btn" onchange="exportDiagram()">
                    <option value="" selected disabled id="exportOption">–≠–∫—Å–ø–æ—Ä—Ç...</option>
                    <option value="png">PNG</option>
                    <option value="jpg">JPG</option>
                    <option value="pdf">PDF</option>
                </select>
            </div>
            
            <!-- Language selector -->
            <div class="dropdown-section">
                <span id="languageLabel">–Ø–∑—ã–∫: </span>
                <select class="language-select" id="languageSelect">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="dropdown-section_1">
                <span id="temLabel">–¢–µ–º–∞: </span>
                <select class="language-select" id="themeSelect">
                    <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                    <option value="dark">–¢–µ–º–Ω–∞—è</option>
                </select>
            </div>
        </div>

        <div id="bpmn-container"></div>
    </div>

    <script>
      
        const container = document.getElementById('bpmn-container');
        const modeler = new BpmnJS({ container });

        const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_1yw2bkb</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:endEvent id="Event_1hglcpn">
      <bpmn:incoming>Flow_0bugmmy</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:task id="Activity_0klqwma">
      <bpmn:incoming>Flow_1yw2bkb</bpmn:incoming>
      <bpmn:outgoing>Flow_1hnjoew</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1yw2bkb" sourceRef="StartEvent_1" targetRef="Activity_0klqwma" />
    <bpmn:exclusiveGateway id="Gateway_1mzzoew">
      <bpmn:incoming>Flow_1hnjoew</bpmn:incoming>
      <bpmn:outgoing>Flow_0ta1uj3</bpmn:outgoing>
      <bpmn:outgoing>Flow_12zseun</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1hnjoew" sourceRef="Activity_0klqwma" targetRef="Gateway_1mzzoew" />
    <bpmn:task id="Activity_1w3naze">
      <bpmn:incoming>Flow_0ta1uj3</bpmn:incoming>
      <bpmn:outgoing>Flow_18rf0dr</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0ta1uj3" sourceRef="Gateway_1mzzoew" targetRef="Activity_1w3naze" />
    <bpmn:task id="Activity_11fdwln">
      <bpmn:incoming>Flow_12zseun</bpmn:incoming>
      <bpmn:outgoing>Flow_1endy95</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_12zseun" sourceRef="Gateway_1mzzoew" targetRef="Activity_11fdwln" />
    <bpmn:task id="Activity_06yd2jr">
      <bpmn:incoming>Flow_1endy95</bpmn:incoming>
      <bpmn:outgoing>Flow_12oui8o</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1endy95" sourceRef="Activity_11fdwln" targetRef="Activity_06yd2jr" />
    <bpmn:task id="Activity_0dw8i1j">
      <bpmn:incoming>Flow_18rf0dr</bpmn:incoming>
      <bpmn:outgoing>Flow_04nyj1d</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_18rf0dr" sourceRef="Activity_1w3naze" targetRef="Activity_0dw8i1j" />
    <bpmn:task id="Activity_0zojsld">
      <bpmn:incoming>Flow_04nyj1d</bpmn:incoming>
      <bpmn:incoming>Flow_12oui8o</bpmn:incoming>
      <bpmn:outgoing>Flow_0bugmmy</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_04nyj1d" sourceRef="Activity_0dw8i1j" targetRef="Activity_0zojsld" />
    <bpmn:sequenceFlow id="Flow_12oui8o" sourceRef="Activity_06yd2jr" targetRef="Activity_0zojsld" />
    <bpmn:sequenceFlow id="Flow_0bugmmy" sourceRef="Activity_0zojsld" targetRef="Event_1hglcpn" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="552" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0klqwma_di" bpmnElement="Activity_0klqwma">
        <dc:Bounds x="520" y="170" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1mzzoew_di" bpmnElement="Gateway_1mzzoew" isMarkerVisible="true">
        <dc:Bounds x="545" y="285" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1w3naze_di" bpmnElement="Activity_1w3naze">
        <dc:Bounds x="650" y="270" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_11fdwln_di" bpmnElement="Activity_11fdwln">
        <dc:Bounds x="400" y="270" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_06yd2jr_di" bpmnElement="Activity_06yd2jr">
        <dc:Bounds x="400" y="400" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0dw8i1j_di" bpmnElement="Activity_0dw8i1j">
        <dc:Bounds x="650" y="400" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0zojsld_di" bpmnElement="Activity_0zojsld">
        <dc:Bounds x="520" y="500" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1hglcpn_di" bpmnElement="Event_1hglcpn">
        <dc:Bounds x="552" y="662" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1yw2bkb_di" bpmnElement="Flow_1yw2bkb">
        <di:waypoint x="570" y="138" />
        <di:waypoint x="570" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1hnjoew_di" bpmnElement="Flow_1hnjoew">
        <di:waypoint x="570" y="250" />
        <di:waypoint x="570" y="285" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ta1uj3_di" bpmnElement="Flow_0ta1uj3">
        <di:waypoint x="595" y="310" />
        <di:waypoint x="650" y="310" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12zseun_di" bpmnElement="Flow_12zseun">
        <di:waypoint x="545" y="310" />
        <di:waypoint x="500" y="310" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1endy95_di" bpmnElement="Flow_1endy95">
        <di:waypoint x="450" y="350" />
        <di:waypoint x="450" y="400" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18rf0dr_di" bpmnElement="Flow_18rf0dr">
        <di:waypoint x="700" y="350" />
        <di:waypoint x="700" y="400" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_04nyj1d_di" bpmnElement="Flow_04nyj1d">
        <di:waypoint x="650" y="440" />
        <di:waypoint x="635" y="440" />
        <di:waypoint x="635" y="540" />
        <di:waypoint x="620" y="540" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12oui8o_di" bpmnElement="Flow_12oui8o">
        <di:waypoint x="500" y="440" />
        <di:waypoint x="510" y="440" />
        <di:waypoint x="510" y="540" />
        <di:waypoint x="520" y="540" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0bugmmy_di" bpmnElement="Flow_0bugmmy">
        <di:waypoint x="570" y="580" />
        <di:waypoint x="570" y="662" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        async function createDiagram() {
            try {
                await modeler.importXML(emptyDiagram);
                //showNotification('–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã', 'error');
            }
        }

        createDiagram();

        async function saveDiagram() {
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

            if (!name) return;

            try {
                const { xml } = await modeler.saveXML({ format: true });

                const response = await fetch('/builder/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        name: name,
                        bpmn: xml,
                        username: '{{ username }}'
                    })
                });

                if(response.ok) {
                    showNotification('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                } else {
                    throw new Error(await response.text());
                }
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        async function loadDiagram() {
            const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

            if (!diagramId) return;

            try {
                const response = await fetch(`/builder/load/${diagramId}/`);
                const { xml } = await response.json();

                await modeler.importXML(xml);
                modeler.get('canvas').zoom('fit-viewport');
                showNotification('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã', 'error');
            }
        }

        async function exportDiagram() {
            const formatSelect = document.getElementById('export-format');
            const format = formatSelect.value;

            if (!format) return;

            try {
                if (format === 'svg') {
                    const { svg } = await modeler.saveSVG();
                    downloadFile(svg, 'diagram.svg', 'image/svg+xml');
                    showNotification('SVG —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                    return;
                }

                if (format === 'pdf') {
                    const { svg } = await modeler.saveSVG();
                    const response = await fetch('/builder/export/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            svg: svg,
                            format: 'pdf',
                            filename: 'diagram'
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        downloadFile(blob, 'diagram.pdf', 'application/pdf');
                        showNotification('PDF —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                    } else {
                        throw new Error(await response.text());
                    }
                    return;
                }

                const { svg } = await modeler.saveSVG();
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    if (format === 'jpg') {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }

                    ctx.drawImage(img, 0, 0);

                    let mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                    canvas.toBlob(blob => {
                        downloadFile(blob, `diagram.${format}`, mimeType);
                        showNotification(`–§–∞–π–ª ${format.toUpperCase()} —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω`, 'success');
                    }, mimeType, 1.0);
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                formatSelect.value = '';
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message, 'error');
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }



        // –û–±—ä–µ–∫—Ç —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const translations = {
        'ru': {
            'diagramTitle': '–î–∏–∞–≥—Ä–∞–º–º–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏',
            'saveButton': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
            'loadButton': '–ó–∞–≥—Ä—É–∑–∏—Ç—å',
            'exitButton': '–í—ã–π—Ç–∏',
            'exportOption': '–≠–∫—Å–ø–æ—Ä—Ç...',
            'languageLabel': '–Ø–∑—ã–∫:',
            'temLabel': '–¢–µ–º–∞:'
        },
        'en': {
            'diagramTitle': 'Activity Diagram',
            'saveButton': 'Save',
            'loadButton': 'Load',
            'exitButton': 'Exit',
            'exportOption': 'Export...',
            'languageLabel': 'Language:',
            'temLabel': 'Theme:'
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function translatePage(lang) {
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
        const t = translations[lang];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.querySelector('h1').textContent = t.diagramTitle;
        document.getElementById('saveButton').innerHTML = `<i>üíæ</i> ${t.saveButton}`;
        document.getElementById('loadButton').innerHTML = `<i>üìÇ</i> ${t.loadButton}`;
        document.getElementById('exitButton').innerHTML = `<i>üö™</i> ${t.exitButton}`;
        document.getElementById('exportOption').textContent = t.exportOption;
        document.getElementById('languageLabel').textContent = t.languageLabel;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ localStorage
        localStorage.setItem('userLanguage', lang);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        updateLanguageOnServer(lang);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    function updateLanguageOnServer(lang) {
        fetch('/update_language/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                language: lang,
                username: '{{ username }}'
            })
        }).catch(err => console.error('Language update error:', err));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
        const languageSelect = document.getElementById('languageSelect');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä—É—Å—Å–∫–∏–π)
        const defaultLanguage = 'ru';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏–∑ localStorage
        const savedLanguage = localStorage.getItem('userLanguage');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ localStorage, –ø–æ—Ç–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const currentLanguage = savedLanguage || defaultLanguage;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        languageSelect.value = currentLanguage;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
        translatePage(currentLanguage);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
        languageSelect.addEventListener('change', function() {
            const selectedLanguage = this.value;
            translatePage(selectedLanguage);
        });
    });

    //—Ç–µ–º–∞
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.remove('dark-theme');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    async function updateTheme(theme) {
        try {
            const response = await fetch('/update_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    theme: theme,
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Failed to update theme');
            }
        } catch (error) {
            console.error('Error updating theme:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function getUserTheme() {
        try {
            const response = await fetch('/get_user_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            return data.theme || 'light';
        } catch (error) {
            console.error('Error getting user theme:', error);
            return 'light';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async function() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        const currentTheme = await getUserTheme();
        applyTheme(currentTheme);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        const themeSelect = document.getElementById('themeSelect');
        if (themeSelect) {
            themeSelect.value = currentTheme;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        themeSelect.addEventListener('change', function() {
            const selectedTheme = this.value;
            applyTheme(selectedTheme);
            updateTheme(selectedTheme);
        });
    });
    </script>

</body>
</html>