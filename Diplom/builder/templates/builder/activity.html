<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN Builder</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º BPMN.js -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <style>
       /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #top-panel { background: #f1f1f1; padding: 10px; display: flex; }
        .btn { padding: 10px; margin-right: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        #bpmn-container { width: 100%; height: 600px; border: 1px solid #ccc; background: #f9f9f9; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>–î–∏–∞–≥—Ä–∞–º–º–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h1>
    <h2>{{ username }}</h2>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã -->
<div id="top-panel">
    <button class="btn" onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" onclick="loadDiagram()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>
    <div id="bpmn-container"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º BPMN.js —á–µ—Ä–µ–∑ CDN -->
    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <script>
        const container = document.getElementById('bpmn-container');
    const modeler = new BpmnJS({ container });

    const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_1yw2bkb</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:endEvent id="Event_1hglcpn">
      <bpmn:incoming>Flow_0bugmmy</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:task id="Activity_0klqwma">
      <bpmn:incoming>Flow_1yw2bkb</bpmn:incoming>
      <bpmn:outgoing>Flow_1hnjoew</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1yw2bkb" sourceRef="StartEvent_1" targetRef="Activity_0klqwma" />
    <bpmn:exclusiveGateway id="Gateway_1mzzoew">
      <bpmn:incoming>Flow_1hnjoew</bpmn:incoming>
      <bpmn:outgoing>Flow_0ta1uj3</bpmn:outgoing>
      <bpmn:outgoing>Flow_12zseun</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1hnjoew" sourceRef="Activity_0klqwma" targetRef="Gateway_1mzzoew" />
    <bpmn:task id="Activity_1w3naze">
      <bpmn:incoming>Flow_0ta1uj3</bpmn:incoming>
      <bpmn:outgoing>Flow_18rf0dr</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0ta1uj3" sourceRef="Gateway_1mzzoew" targetRef="Activity_1w3naze" />
    <bpmn:task id="Activity_11fdwln">
      <bpmn:incoming>Flow_12zseun</bpmn:incoming>
      <bpmn:outgoing>Flow_1endy95</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_12zseun" sourceRef="Gateway_1mzzoew" targetRef="Activity_11fdwln" />
    <bpmn:task id="Activity_06yd2jr">
      <bpmn:incoming>Flow_1endy95</bpmn:incoming>
      <bpmn:outgoing>Flow_12oui8o</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1endy95" sourceRef="Activity_11fdwln" targetRef="Activity_06yd2jr" />
    <bpmn:task id="Activity_0dw8i1j">
      <bpmn:incoming>Flow_18rf0dr</bpmn:incoming>
      <bpmn:outgoing>Flow_04nyj1d</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_18rf0dr" sourceRef="Activity_1w3naze" targetRef="Activity_0dw8i1j" />
    <bpmn:task id="Activity_0zojsld">
      <bpmn:incoming>Flow_04nyj1d</bpmn:incoming>
      <bpmn:incoming>Flow_12oui8o</bpmn:incoming>
      <bpmn:outgoing>Flow_0bugmmy</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_04nyj1d" sourceRef="Activity_0dw8i1j" targetRef="Activity_0zojsld" />
    <bpmn:sequenceFlow id="Flow_12oui8o" sourceRef="Activity_06yd2jr" targetRef="Activity_0zojsld" />
    <bpmn:sequenceFlow id="Flow_0bugmmy" sourceRef="Activity_0zojsld" targetRef="Event_1hglcpn" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="552" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0klqwma_di" bpmnElement="Activity_0klqwma">
        <dc:Bounds x="520" y="170" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1mzzoew_di" bpmnElement="Gateway_1mzzoew" isMarkerVisible="true">
        <dc:Bounds x="545" y="285" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1w3naze_di" bpmnElement="Activity_1w3naze">
        <dc:Bounds x="650" y="270" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_11fdwln_di" bpmnElement="Activity_11fdwln">
        <dc:Bounds x="400" y="270" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_06yd2jr_di" bpmnElement="Activity_06yd2jr">
        <dc:Bounds x="400" y="400" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0dw8i1j_di" bpmnElement="Activity_0dw8i1j">
        <dc:Bounds x="650" y="400" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0zojsld_di" bpmnElement="Activity_0zojsld">
        <dc:Bounds x="520" y="500" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1hglcpn_di" bpmnElement="Event_1hglcpn">
        <dc:Bounds x="552" y="662" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1yw2bkb_di" bpmnElement="Flow_1yw2bkb">
        <di:waypoint x="570" y="138" />
        <di:waypoint x="570" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1hnjoew_di" bpmnElement="Flow_1hnjoew">
        <di:waypoint x="570" y="250" />
        <di:waypoint x="570" y="285" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ta1uj3_di" bpmnElement="Flow_0ta1uj3">
        <di:waypoint x="595" y="310" />
        <di:waypoint x="650" y="310" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12zseun_di" bpmnElement="Flow_12zseun">
        <di:waypoint x="545" y="310" />
        <di:waypoint x="500" y="310" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1endy95_di" bpmnElement="Flow_1endy95">
        <di:waypoint x="450" y="350" />
        <di:waypoint x="450" y="400" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18rf0dr_di" bpmnElement="Flow_18rf0dr">
        <di:waypoint x="700" y="350" />
        <di:waypoint x="700" y="400" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_04nyj1d_di" bpmnElement="Flow_04nyj1d">
        <di:waypoint x="650" y="440" />
        <di:waypoint x="635" y="440" />
        <di:waypoint x="635" y="540" />
        <di:waypoint x="620" y="540" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12oui8o_di" bpmnElement="Flow_12oui8o">
        <di:waypoint x="500" y="440" />
        <di:waypoint x="510" y="440" />
        <di:waypoint x="510" y="540" />
        <di:waypoint x="520" y="540" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0bugmmy_di" bpmnElement="Flow_0bugmmy">
        <di:waypoint x="570" y="580" />
        <di:waypoint x="570" y="662" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    async function createDiagram() {
        try {
            await modeler.importXML(emptyDiagram);
            console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
        }
    }

    createDiagram();

    async function saveDiagram() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

        try {
            const { xml } = await modeler.saveXML({ format: true });

            const response = await fetch('/builder/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    bpmn: xml,
                    username: '{{ username }}'  // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                })
            });

            if(response.ok) {
                alert('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            }
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    async function loadDiagram() {
        const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

        if (!diagramId) return;

        try {
            const response = await fetch(`/builder/load/${diagramId}/`);
            const { xml } = await response.json();

            await modeler.importXML(xml);
            modeler.get('canvas').zoom('fit-viewport');
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
    }
    </script>
</body>
</html>