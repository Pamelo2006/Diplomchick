<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ diagram.name }}</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        #top-panel {
            background: #f1f1f1;
            padding: 10px;
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background: #45a049;
        }
        .diagram-container {
            width: 100%;
            max-width: 800px;
            height: 500px;
            margin: auto;
            border: 1px solid #ccc;
            background: #fff;
            position: relative;
        }
    </style>
</head>
<body>

    <h1>{{ diagram.name }}</h1>
    <h2>{{ username }}</h2>
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="top-panel">
        <button class="btn" onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="loadDiagram()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button class="btn" onclick="confirmExit()">–≤—ã–π—Ç–∏</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã -->
    <div id="bpmn-container" class="diagram-container"></div>

    <script>
        const container = document.getElementById('bpmn-container');
        const modeler = new BpmnJS({ container });

        async function loadDiagram() {
            try {
                await modeler.importXML(`{{ diagram.xml_data|escapejs }}`);
                modeler.get("canvas").zoom("fit-viewport");
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
            }
        }

        async function saveDiagram() {
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

            try {
                const { xml } = await modeler.saveXML({ format: true });

                const response = await fetch('/builder/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        name: name,
                        bpmn: xml,
                        username: '{{ username }}'  // –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ID: ' + data.id);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function confirmExit() {
            const isConfirmed = confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –î–∏–∞–≥—Ä–∞–º–º–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.");
            if (isConfirmed) {
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ URL, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –º–µ—Ç–æ–¥–æ–º back_to_diagrams
                window.location.href = "{% url 'back_to_diagrams' %}";
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("DOMContentLoaded", loadDiagram);
    </script>

</body>
</html>