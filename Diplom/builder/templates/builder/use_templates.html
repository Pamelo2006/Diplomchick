<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ diagram.name }}</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <style>
        :root {
            --primary-color: #66a5ad;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --light-gray: #f5f7fa;
            --dark-gray: #333;
            --white: #fff;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background-color: var(--light-gray);
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin: 0;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--white);
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        #top-panel {
            background: var(--white);
            padding: 15px;
            display: flex;
            gap: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 1rem;
        }

        .diagram-container {
            width: 100%;
            height: 600px;
            margin: 0 auto;
            border: 1px solid #ddd;
            background: var(--white);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: var(--white);
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .export-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-wrapper label {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #top-panel {
                flex-direction: column;
            }
            
            .btn, select {
                width: 100%;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .diagram-container {
            animation: fadeIn 0.5s ease-in;
        }
        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    body.dark-theme {
        --light-gray: #121212;
        --dark-gray: #e0e0e0;
        --white: #1e1e1e;
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }

    body.dark-theme header {
        background-color: #1a1a1a;
        
    }

    body.dark-h1{
        color: #e0e0e0;;
    }

    body.dark-theme #top-panel {
        background: #2d2d2d;
        color: var(--dark-gray);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    body.dark-theme select {
        background-color: #3d3d3d;
        color: var(--dark-gray);
        border-color: #444;
    }

    body.dark-theme .btn {
        background-color: #2d2d2d;
        color: var(--dark-gray);
    }

    body.dark-theme .btn:hover {
        background-color: #3d3d3d;
    }

    body.dark-theme #bpmn-container {
        background: #2d2d2d;
        border-color: #444;
    }

    body.dark-theme .export-wrapper label {
        color: var(--dark-gray);
    }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div>
                <h1>{{ diagram.name }}</h1>
                <h2>{{ username }}</h2>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="top-panel">
            <button class="btn" id="saveButton" onclick="saveDiagram()">
                <i>üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn" id="loadButton" onclick="loadDiagram()">
                <i>üìÇ</i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
            <form action="{% url 'back_to_diagrams' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn" id="exitButton">
                    <i>üö™</i> –í—ã–π—Ç–∏
                </button>
            </form>
            
            <div class="export-wrapper">
                <select id="export-format" class="btn" onchange="exportDiagram()">
                    <option value="" selected disabled id="exportOption">–≠–∫—Å–ø–æ—Ä—Ç...</option>
                    <option value="png">PNG</option>
                    <option value="jpg">JPG</option>
                    <option value="pdf">PDF</option>
                </select>
            </div>
    
            <div class="dropdown-section">
                <span id="languageLabel">–Ø–∑—ã–∫: </span>
                <select class="language-select" id="languageSelect">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="dropdown-section_1">
                <span id="temLabel">–¢–µ–º–∞: </span>
                <select class="language-select" id="themeSelect">
                    <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                    <option value="dark">–¢–µ–º–Ω–∞—è</option>
                </select>
            </div>
        </div>
        <div id="bpmn-container" class="diagram-container"></div>
    </div>
    <script>
        const container = document.getElementById('bpmn-container');
        const modeler = new BpmnJS({ container });

        async function loadDiagram() {
            try {
                await modeler.importXML(`{{ diagram.xml_data|escapejs }}`);
                modeler.get("canvas").zoom("fit-viewport");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                //showNotification('–î–∏–∞–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã', 'error');
            }
        }

        async function saveDiagram() {
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "{{ diagram.name }}");

            if (!name) return;

            try {
                const { xml } = await modeler.saveXML({ format: true });

                const response = await fetch('/builder/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        name: name,
                        bpmn: xml,
                        username: '{{ username }}'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ID: ' + data.id, 'success');
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        function confirmExit() {
            const isConfirmed = confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?");
            if (isConfirmed) {
                window.location.href = "{% url 'back_to_diagrams' %}";
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("DOMContentLoaded", loadDiagram);

        async function exportDiagram() {
            const formatSelect = document.getElementById('export-format');
            const format = formatSelect.value;

            if (!format) return;

            try {
                if (format === 'svg') {
                    const { svg } = await modeler.saveSVG();
                    downloadFile(svg, 'diagram.svg', 'image/svg+xml');
                    return;
                }

                if (format === 'pdf') {
                    const { svg } = await modeler.saveSVG();
                    const response = await fetch('/builder/export/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            svg: svg,
                            format: 'pdf',
                            filename: 'diagram'
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        downloadFile(blob, 'diagram.pdf', 'application/pdf');
                        showNotification('PDF —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                    } else {
                        throw new Error(await response.text());
                    }
                    return;
                }

                const { svg } = await modeler.saveSVG();
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    if (format === 'jpg') {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }

                    ctx.drawImage(img, 0, 0);

                    let mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                    canvas.toBlob(blob => {
                        downloadFile(blob, `diagram.${format}`, mimeType);
                        showNotification(`–§–∞–π–ª ${format.toUpperCase()} —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω`, 'success');
                    }, mimeType, 1.0);
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                formatSelect.value = '';
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message, 'error');
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '4px';
            notification.style.color = 'white';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            
            if (type === 'success') {
                notification.style.background = 'var(--success-color)';
            } else if (type === 'error') {
                notification.style.background = 'var(--error-color)';
            } else {
                notification.style.background = 'var(--warning-color)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        // –û–±—ä–µ–∫—Ç —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const translations = {
        'ru': {
            'diagramTitle': '{{ diagram.name }}',
            'saveButton': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
            'loadButton': '–ó–∞–≥—Ä—É–∑–∏—Ç—å',
            'exitButton': '–í—ã–π—Ç–∏',
            'exportOption': '–≠–∫—Å–ø–æ—Ä—Ç...',
            'languageLabel': '–Ø–∑—ã–∫:'
        },
        'en': {
            'diagramTitle': '{{ diagram.name }}',
            'saveButton': 'Save',
            'loadButton': 'Load',
            'exitButton': 'Exit',
            'exportOption': 'Export...',
            'languageLabel': 'Language:'
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function translatePage(lang) {
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
        const t = translations[lang];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.querySelector('h1').textContent = t.diagramTitle;
        document.getElementById('saveButton').innerHTML = `<i>üíæ</i> ${t.saveButton}`;
        document.getElementById('loadButton').innerHTML = `<i>üìÇ</i> ${t.loadButton}`;
        document.getElementById('exitButton').innerHTML = `<i>üö™</i> ${t.exitButton}`;
        document.getElementById('exportOption').textContent = t.exportOption;
        document.getElementById('languageLabel').textContent = t.languageLabel;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ localStorage
        localStorage.setItem('userLanguage', lang);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        updateLanguageOnServer(lang);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    function updateLanguageOnServer(lang) {
        fetch('/update_language/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                language: lang,
                username: '{{ username }}'
            })
        }).catch(err => console.error('Language update error:', err));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
        const languageSelect = document.getElementById('languageSelect');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä—É—Å—Å–∫–∏–π)
        const defaultLanguage = 'ru';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏–∑ localStorage
        const savedLanguage = localStorage.getItem('userLanguage');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ localStorage, –ø–æ—Ç–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const currentLanguage = savedLanguage || defaultLanguage;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        languageSelect.value = currentLanguage;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
        translatePage(currentLanguage);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
        languageSelect.addEventListener('change', function() {
            const selectedLanguage = this.value;
            translatePage(selectedLanguage);
        });
    });

    //—Ç–µ–º–∞
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.remove('dark-theme');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    async function updateTheme(theme) {
        try {
            const response = await fetch('/update_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    theme: theme,
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Failed to update theme');
            }
        } catch (error) {
            console.error('Error updating theme:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function getUserTheme() {
        try {
            const response = await fetch('/get_user_theme/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    username: '{{ username }}'
                })
            });

            const data = await response.json();
            return data.theme || 'light';
        } catch (error) {
            console.error('Error getting user theme:', error);
            return 'light';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async function() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        const currentTheme = await getUserTheme();
        applyTheme(currentTheme);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
        const themeSelect = document.getElementById('themeSelect');
        if (themeSelect) {
            themeSelect.value = currentTheme;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        themeSelect.addEventListener('change', function() {
            const selectedTheme = this.value;
            applyTheme(selectedTheme);
            updateTheme(selectedTheme);
        });
    });
    </script>
</body>
</html>