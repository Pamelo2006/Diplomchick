<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swimlane Diagram with BPMN.js</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º BPMN.js -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14.0.0/dist/assets/bpmn-font/css/bpmn.css" />
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #top-panel { background: #f1f1f1; padding: 10px; display: flex; }
        .btn { padding: 10px; margin-right: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        #bpmn-container { width: 100%; height: 600px; border: 1px solid #ccc; background: #f9f9f9; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–ª–∞–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–æ—Ä–æ–∂–µ–∫</h1>
    <h2>{{ username }}</h2>
    <div id="top-panel">
        <button class="btn" onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="loadDiagram()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è BPMN –¥–∏–∞–≥—Ä–∞–º–º—ã -->
    <div id="bpmn-container"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º BPMN.js —á–µ—Ä–µ–∑ CDN -->
    <script src="https://unpkg.com/bpmn-js@14.0.0/dist/bpmn-modeler.development.js"></script>
    <script>
       const container = document.getElementById('bpmn-container');
    const modeler = new BpmnJS({ container });

    const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:collaboration id="Collaboration_1dhhwh8">
    <bpmn:participant id="Participant_0komfq1" processRef="Process_1" />
  </bpmn:collaboration>
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:laneSet id="LaneSet_0ryq5ui">
      <bpmn:lane id="Lane_0s9tz3x" name="–†–µ–∞–ª—Ç–∑–∞—Ü–∏—è">
        <bpmn:flowNodeRef>Activity_0ebhlb3</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_0osje4e" name="–ò–æ—Ç–≥">
        <bpmn:flowNodeRef>Activity_0u5bj0c</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_1rpwhmo" name="–ò–¥–µ—è">
        <bpmn:flowNodeRef>Activity_13njn8r</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:task id="Activity_13njn8r" name="–ó–∞–¥—É–º–∫–∞">
      <bpmn:outgoing>Flow_0434ytz</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0434ytz" sourceRef="Activity_13njn8r" targetRef="Activity_0ebhlb3" />
    <bpmn:task id="Activity_0ebhlb3" name="—Å–æ–∑–¥–∞–Ω–∏–µ">
      <bpmn:incoming>Flow_0434ytz</bpmn:incoming>
      <bpmn:outgoing>Flow_1akoszk</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_1akoszk" sourceRef="Activity_0ebhlb3" targetRef="Activity_0u5bj0c" />
    <bpmn:task id="Activity_0u5bj0c" name="–†–µ–∑—É–ª—å—Ç–∞—Ç">
      <bpmn:incoming>Flow_1akoszk</bpmn:incoming>
    </bpmn:task>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_1dhhwh8">
      <bpmndi:BPMNShape id="Participant_0komfq1_di" bpmnElement="Participant_0komfq1" isHorizontal="true">
        <dc:Bounds x="370" y="80" width="600" height="370" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0s9tz3x_di" bpmnElement="Lane_0s9tz3x" isHorizontal="true">
        <dc:Bounds x="400" y="200" width="570" height="125" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0osje4e_di" bpmnElement="Lane_0osje4e" isHorizontal="true">
        <dc:Bounds x="400" y="325" width="570" height="125" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1rpwhmo_di" bpmnElement="Lane_1rpwhmo" isHorizontal="true">
        <dc:Bounds x="400" y="80" width="570" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_13njn8r_di" bpmnElement="Activity_13njn8r">
        <dc:Bounds x="460" y="100" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ebhlb3_di" bpmnElement="Activity_0ebhlb3">
        <dc:Bounds x="590" y="220" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0u5bj0c_di" bpmnElement="Activity_0u5bj0c">
        <dc:Bounds x="780" y="340" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0434ytz_di" bpmnElement="Flow_0434ytz">
        <di:waypoint x="560" y="140" />
        <di:waypoint x="575" y="140" />
        <di:waypoint x="575" y="260" />
        <di:waypoint x="590" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1akoszk_di" bpmnElement="Flow_1akoszk">
        <di:waypoint x="690" y="260" />
        <di:waypoint x="735" y="260" />
        <di:waypoint x="735" y="380" />
        <di:waypoint x="780" y="380" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    async function createDiagram() {
        try {
            await modeler.importXML(emptyDiagram);
            console.log("–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
        }
    }

    createDiagram();

    async function saveDiagram() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã:", "–ù–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞");

        try {
            const { xml } = await modeler.saveXML({ format: true });

            const response = await fetch('/builder/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    bpmn: xml,
                    username: '{{ username }}'  // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                })
            });

            if(response.ok) {
                alert('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            }
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    async function loadDiagram() {
        const diagramId = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥–∏–∞–≥—Ä–∞–º–º—ã:");

        if (!diagramId) return;

        try {
            const response = await fetch(`/builder/load/${diagramId}/`);
            const { xml } = await response.json();

            await modeler.importXML(xml);
            modeler.get('canvas').zoom('fit-viewport');
        } catch(error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        }
    }
    </script>
</body>
</html>
